<div class="form-container">
  <div class="form-header">
    <div class="header-content">
      <div class="header-icon">
        <i class="pi pi-wallet"></i>
      </div>
      <div class="header-text">
        <h1 class="form-title">
          {{ (isEditMode$ | async) ? ('editWallet.edit.title' | translate) + (editWalletForm.get('name')?.value || '') : ('editWallet.create.title' | translate) }}
        </h1>
        <p class="form-subtitle">
          {{ (isEditMode$ | async) ? ('editWallet.edit.subtitle' | translate) : ('editWallet.create.subtitle' | translate) }}
        </p>
      </div>
    </div>
    <div class="header-actions">
      <button
        type="button"
        pButton
        [label]="'editWallet.back_to_wallets' | translate"
        icon="pi pi-arrow-left"
        class="p-button-text"
        (click)="onCancel()"
        [disabled]="(isUpdatingWallet$ | async) || (isCreatingWallet$ | async)"
      ></button>
    </div>
  </div>

  <div class="form-content">
    <form [formGroup]="editWalletForm" (ngSubmit)="onSubmit()" class="form">
      
             <!-- Hidden balance field (required by model but calculated automatically) -->
       <input type="hidden" formControlName="balance" />
      
      <!-- Basic Information Section -->
      <div class="form-section">
        <h3 class="section-title">
          <i class="pi pi-info-circle"></i>
          {{ 'editWallet.sections.basic_info' | translate }}
        </h3>
        
        <div class="form-row">
          <div class="form-field">
            <label for="name" class="field-label">
              {{ 'editWallet.fields.wallet_name' | translate }} <span class="required">*</span>
            </label>
            <input
              id="name"
              type="text"
              pInputText
              formControlName="name"
              [placeholder]="'editWallet.placeholders.enter_wallet_name' | translate"
              [class.invalid]="isFieldInvalid('name')"
              class="form-input"
              maxlength="50"
              autocomplete="off"
            />
            <div *ngIf="isFieldInvalid('name')" class="error-message">
              {{ getFieldError('name') }}
            </div>
            <small class="field-hint">{{ 'editWallet.hints.wallet_name' | translate }}</small>
          </div>

          <div class="form-field">
            <label for="type" class="field-label">
              {{ 'editWallet.fields.wallet_type' | translate }} <span class="required">*</span>
            </label>
            <p-dropdown
              id="type"
              formControlName="type"
              [options]="(walletTypes$ | async) || []"
              optionLabel="label"
              optionValue="value"
              [placeholder]="'editWallet.placeholders.select_wallet_type' | translate"
              [class.invalid]="isFieldInvalid('type')"
              class="form-dropdown"
              [showClear]="false"
              [filter]="false"
              appendTo="body"
              [overlayOptions]="{ autoZIndex: true }"
            ></p-dropdown>
            <div *ngIf="isFieldInvalid('type')" class="error-message">
              {{ getFieldError('type') }}
            </div>
            <small class="field-hint">{{ 'editWallet.hints.wallet_type' | translate }}</small>
          </div>
        </div>

        <div class="form-row">
          <div class="form-field">
            <label for="currency" class="field-label">
              {{ 'editWallet.fields.currency' | translate }} <span class="required">*</span>
            </label>
                         <p-dropdown
               id="currency"
               formControlName="currency"
               [options]="(currencies$ | async) || []"
               optionLabel="label"
               optionValue="value"
               [placeholder]="'editWallet.placeholders.select_currency' | translate"
               [class.invalid]="isFieldInvalid('currency')"
               class="form-dropdown"
               [showClear]="false"
               [filter]="false"
               appendTo="body"
               [readonly]="(isEditMode$ | async)"
               [overlayOptions]="{ autoZIndex: true }"
             ></p-dropdown>
             <div *ngIf="isFieldInvalid('currency')" class="error-message">
               {{ getFieldError('currency') }}
             </div>
             <small class="field-hint">
               {{ (isEditMode$ | async) ? ('editWallet.hints.currency_edit' | translate) : ('editWallet.hints.currency_create' | translate) }}
             </small>
          </div>

          <div class="form-field">
            <label for="iconUrl" class="field-label">
              {{ 'editWallet.fields.icon_url' | translate }} <span class="optional">({{ 'editWallet.validation.optional' | translate }})</span>
            </label>
            <div class="icon-input-container">
              <input
                id="iconUrl"
                type="url"
                pInputText
                formControlName="iconUrl"
                [placeholder]="'editWallet.placeholders.icon_url_placeholder' | translate"
                class="form-input"
                (input)="onIconUrlChange()"
                autocomplete="url"
              />
              <div class="icon-preview" *ngIf="editWalletForm.get('iconUrl')?.value">
                <img
                  [src]="editWalletForm.get('iconUrl')?.value"
                  [alt]="'Icon preview'"
                  class="preview-image"
                  (error)="onIconPreviewError($event)"
                  (load)="onIconPreviewLoad()"
                />
                <div class="preview-overlay" *ngIf="!iconPreviewLoaded">
                  <i class="pi pi-spin pi-spinner"></i>
                </div>
              </div>
            </div>
            <small class="field-hint">{{ 'editWallet.hints.icon_url' | translate }}</small>
            <div *ngIf="iconPreviewError" class="warning-message">
              {{ 'editWallet.messages.icon_preview_error' | translate }}
            </div>
          </div>
        </div>
      </div>

      <!-- Financial Information Section -->
      <div class="form-section">
        <h3 class="section-title">
          <i class="pi pi-dollar"></i>
          {{ 'editWallet.sections.financial_info' | translate }}
        </h3>
        


        <div class="form-row">
          <div class="form-field">
            <label for="initialBalance" class="field-label">
              {{ 'editWallet.fields.initial_amount' | translate }} <span class="required">*</span>
            </label>
            <p-inputNumber
              id="initialBalance"
              formControlName="initialBalance"
              [placeholder]="'editWallet.placeholders.amount_placeholder' | translate"
              [maxFractionDigits]="2"
              [class.invalid]="isFieldInvalid('initialBalance')"
              class="form-input-number"
              mode="currency"
              [currency]="editWalletForm.get('currency')?.value || 'USD'"
            ></p-inputNumber>
            <div *ngIf="isFieldInvalid('initialBalance')" class="error-message">
              {{ getFieldError('initialBalance') }}
            </div>
            <small class="field-hint">{{ 'editWallet.hints.initial_amount' | translate }}</small>
          </div>

          <div class="form-field">
            <label for="goalAmount" class="field-label">
              {{ 'editWallet.fields.goal_amount' | translate }} <span class="optional">({{ 'editWallet.validation.optional' | translate }})</span>
            </label>
            <p-inputNumber
              id="goalAmount"
              formControlName="goalAmount"
              [placeholder]="'editWallet.placeholders.amount_placeholder' | translate"
              [min]="0"
              [maxFractionDigits]="2"
              class="form-input-number"
              mode="currency"
              [currency]="editWalletForm.get('currency')?.value || 'USD'"
            ></p-inputNumber>
            <small class="field-hint">{{ 'editWallet.hints.goal_amount' | translate }}</small>
          </div>
        </div>
      </div>

      <!-- Settings Section -->
      <div class="form-section">
        <h3 class="section-title">
          <i class="pi pi-cog"></i>
          {{ 'editWallet.sections.settings' | translate }}
        </h3>
        
        <div class="form-row single-column">
          <div class="form-field">
            <label for="isDefault" class="field-label">
              {{ 'editWallet.fields.default_wallet' | translate }}
            </label>
            <div class="checkbox-container">
              <p-checkbox
                id="isDefault"
                formControlName="isDefault"
                [binary]="true"
                class="form-checkbox"
              ></p-checkbox>
              <label for="isDefault" class="checkbox-label">{{ 'editWallet.labels.set_as_default' | translate }}</label>
            </div>
            <small class="field-hint">{{ 'editWallet.hints.default_wallet' | translate }}</small>
            <div *ngIf="editWalletForm.get('isDefault')?.value" class="success-message">
              {{ 'editWallet.messages.default_wallet_set' | translate }}
            </div>
          </div>
        </div>

        <!-- Additional Settings -->
        <div class="form-row">
          <div class="form-field">
            <label for="description" class="field-label">
              {{ 'editWallet.fields.description' | translate }} <span class="optional">({{ 'editWallet.validation.optional' | translate }})</span>
            </label>
            <textarea
              id="description"
              formControlName="description"
                              [placeholder]="'editWallet.placeholders.description_placeholder' | translate"
              class="form-textarea"
              rows="3"
              maxlength="200"
            ></textarea>
            <small class="field-hint">{{ 'editWallet.hints.description' | translate }}</small>
            <div *ngIf="editWalletForm.get('description')?.value" class="field-hint">
              {{ (editWalletForm.get('description')?.value?.length || 0) }}/200 {{ 'editWallet.labels.characters' | translate }}
            </div>
          </div>

          <div class="form-field">
            <label for="color" class="field-label">
              {{ 'editWallet.fields.wallet_color' | translate }} <span class="optional">({{ 'editWallet.validation.optional' | translate }})</span>
            </label>
            <div class="color-picker-container">
              <input
                id="color"
                type="color"
                formControlName="color"
                class="form-color-picker"
                [value]="editWalletForm.get('color')?.value || '#3b82f6'"
                (input)="onColorChange($event)"
              />
              <input
                type="text"
                class="form-hex-input"
                [placeholder]="'editWallet.placeholders.hex_color' | translate"
                [value]="editWalletForm.get('color')?.value || '#3b82f6'"
                (input)="onHexInputChange($event)"
                maxlength="7"
                pattern="^#[0-9A-Fa-f]{6}$"
              />
            </div>
            <small class="field-hint">{{ 'editWallet.hints.wallet_color' | translate }}</small>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <div class="form-actions-left">
          <button
            type="button"
            pButton
            [label]="'editWallet.buttons.cancel' | translate"
            icon="pi pi-times"
            class="p-button-outlined"
            (click)="onCancel()"
            [disabled]="(isUpdatingWallet$ | async) || (isCreatingWallet$ | async)"
          ></button>
        </div>
        
        <div class="form-actions-right">
          <button
            type="submit"
            pButton
            [label]="(isEditMode$ | async) ? ('editWallet.buttons.update_wallet' | translate) : ('editWallet.buttons.create_wallet' | translate)"
            [icon]="(isEditMode$ | async) ? 'pi pi-check' : 'pi pi-plus'"
            class="p-button-primary"
                          [disabled]="editWalletForm.invalid || (isUpdatingWallet$ | async) || (isCreatingWallet$ | async)"
          ></button>
        </div>
      </div>
    </form>
  </div>
</div>
