<div class="transaction-form">
  <form
    [formGroup]="transactionForm"
    (ngSubmit)="onSubmit()"
    class="transaction-form__content"
  >
    <!-- Transaction Type Field -->
    <div class="form-field">
      <label class="form-field__label">
        {{ "transactions.form.type" | translate }}
        <span class="required">{{ "transactions.form.required" | translate }}</span>
      </label>
      <div class="transaction-type-selector transaction-type-selector--grid">
        <div 
          *ngFor="let option of transactionTypeOptions" 
          class="transaction-type-option"
          [class.selected]="transactionForm.get('transactionType')?.value === option.value"
          (click)="selectTransactionType(option.value)"
        >
          <div class="transaction-type-option__icon">
            <i [class]="getTransactionTypeIcon(option.value)"></i>
          </div>
          <div class="transaction-type-option__content">
            <div class="transaction-type-option__label">{{ option.label }}</div>
          </div>
          <div class="transaction-type-option__radio">
            <input 
              type="radio" 
              [value]="option.value"
              formControlName="transactionType"
              [id]="'transaction-type-' + option.value"
              class="sr-only"
            />
            <div class="radio-indicator"></div>
          </div>
        </div>
      </div>
      <small
        *ngIf="getFieldError('transactionType')"
        class="p-error"
        style="display: block; margin-top: 0.25rem"
      >
        {{ getFieldError('transactionType') }}
      </small>
    </div>

    <!-- Category Field (for Income/Expense) -->
    <div class="form-field" *ngIf="shouldShowCategoryField()">
      <label for="transaction-category" class="form-field__label">
        {{ "transactions.form.category" | translate }}
        <span class="required">{{ "transactions.form.required" | translate }}</span>
      </label>
      <app-category-selector
        [selectedCategoryId]="transactionForm.get('categoryId')?.value"
        [transactionType]="transactionForm.get('transactionType')?.value"
        [isInvalid]="(transactionForm.get('categoryId')?.invalid && transactionForm.get('categoryId')?.touched) || false"
        [placeholder]="'transactions.form.categoryPlaceholder'"
        (categorySelected)="onCategorySelected($event)"
        (categoryCleared)="onCategoryCleared()"
        (categoryTouched)="onCategoryTouched()"
      ></app-category-selector>
      <small
        *ngIf="getFieldError('categoryId')"
        class="p-error"
        style="display: block; margin-top: 0.25rem"
      >
        {{ getFieldError('categoryId') }}
      </small>
    </div>

    <!-- From Wallet Field (for Transfer/Expense) -->
    <div class="form-field" *ngIf="shouldShowFromWalletField()">
      <label for="wallet-from" class="form-field__label">
        {{ "transactions.form.fromWallet" | translate }}
        <span class="required" *ngIf="shouldShowFromWalletRequired()">{{ "transactions.form.required" | translate }}</span>
      </label>
      <app-wallet-selector
        [selectedWalletId]="transactionForm.get('walletFromId')?.value"
        [isInvalid]="(transactionForm.get('walletFromId')?.invalid && transactionForm.get('walletFromId')?.touched) || false"
        [placeholder]="'transactions.form.fromWalletPlaceholder'"
        [showAllWallets]="true"
        (walletSelected)="onFromWalletSelected($event)"
        (walletCleared)="onFromWalletCleared()"
        (walletTouched)="onFromWalletTouched()"
      ></app-wallet-selector>
      <small
        *ngIf="getFieldError('walletFromId')"
        class="p-error"
        style="display: block; margin-top: 0.25rem"
      >
        {{ getFieldError('walletFromId') }}
      </small>
    </div>

    <!-- To Wallet Field (for Transfer/Income) -->
    <div class="form-field" *ngIf="shouldShowToWalletField()">
      <label for="wallet-to" class="form-field__label">
        {{ "transactions.form.toWallet" | translate }}
        <span class="required" *ngIf="shouldShowToWalletRequired()">{{ "transactions.form.required" | translate }}</span>
      </label>
      <app-wallet-selector
        [selectedWalletId]="transactionForm.get('walletToId')?.value"
        [isInvalid]="(transactionForm.get('walletToId')?.invalid && transactionForm.get('walletToId')?.touched) || false"
        [placeholder]="'transactions.form.toWalletPlaceholder'"
        [showAllWallets]="true"
        (walletSelected)="onToWalletSelected($event)"
        (walletCleared)="onToWalletCleared()"
        (walletTouched)="onToWalletTouched()"
      ></app-wallet-selector>
      <small
        *ngIf="getFieldError('walletToId')"
        class="p-error"
        style="display: block; margin-top: 0.25rem"
      >
        {{ getFieldError('walletToId') }}
      </small>
    </div>

    <!-- Amount Field -->
    <div class="form-field">
      <label for="transaction-amount" class="form-field__label">
        {{ "transactions.form.amount" | translate }}
        <span class="required">{{ "transactions.form.required" | translate }}</span>
      </label>
      <div class="amount-input-container">
        <div class="amount-input-wrapper">
          <span class="amount-currency-symbol">
            {{ 
            getCurrencySymbol(getWalletCurrency(transactionForm.get('walletFromId')?.value)) ||
            getCurrencySymbol(getWalletCurrency(transactionForm.get('walletToId')?.value)) ||
            '-' }}
          </span>
          <input
            id="transaction-amount"
            type="number"
            formControlName="amount"
            [placeholder]="'transactions.form.amountPlaceholder' | translate"
            min="0.01"
            step="0.01"
            inputmode="decimal"
            [class.p-invalid]="
              transactionForm.get('amount')?.invalid &&
              transactionForm.get('amount')?.touched
            "
            class="amount-input"
          />
        </div>
      </div>
      <small
        *ngIf="getFieldError('amount')"
        class="p-error"
        style="display: block; margin-top: 0.25rem"
      >
        {{ getFieldError('amount') }}
      </small>
    </div>

    <!-- Exchange Rate Field (for different currencies) -->
    <div class="form-field" *ngIf="shouldShowExchangeRateField()">
      <label for="exchange-rate" class="form-field__label">
        {{ "transactions.form.exchangeRate" | translate }}
        <span class="required">{{ "transactions.form.required" | translate }}</span>
        <span class="exchange-rate-label">
          {{ getWalletCurrency(transactionForm.get('walletFromId')?.value) }} to {{ getWalletCurrency(transactionForm.get('walletToId')?.value) }}
        </span>
      </label>
      <p-inputNumber
        id="exchange-rate"
        formControlName="exchangeRate"
        [placeholder]="'transactions.form.exchangeRatePlaceholder' | translate"
        [min]="0.0001"
        [step]="0.0001"
        [useGrouping]="false"
        [minFractionDigits]="1"
        [maxFractionDigits]="6"
        [class.p-invalid]="
          transactionForm.get('exchangeRate')?.invalid &&
          transactionForm.get('exchangeRate')?.touched
        "
        styleClass="w-full"
      />
      <small
        *ngIf="getFieldError('exchangeRate')"
        class="p-error"
        style="display: block; margin-top: 0.25rem"
      >
        {{ getFieldError('exchangeRate') }}
      </small>
    </div>

    <!-- Amount To Field (for different currencies) -->
    <div class="form-field" *ngIf="shouldShowAmountToField()">
      <label for="transaction-amount-to" class="form-field__label">
        {{ "transactions.form.amountTo" | translate }}
        <span class="required">{{ "transactions.form.required" | translate }}</span>
      </label>
      <div class="amount-input-container">
        <div class="amount-input-wrapper">
          <span class="amount-currency-symbol">
            {{ getCurrencySymbol(getWalletCurrency(transactionForm.get('walletToId')?.value)) || '-' }}
          </span>
          <input
            id="transaction-amount-to"
            type="number"
            formControlName="amountTo"
            [placeholder]="'transactions.form.amountToPlaceholder' | translate"
            min="0.01"
            step="0.01"
            inputmode="decimal"
            readonly
            [class.p-invalid]="
              transactionForm.get('amountTo')?.invalid &&
              transactionForm.get('amountTo')?.touched
            "
            class="amount-input"
          />
        </div>
      </div>
      <small
        *ngIf="getFieldError('amountTo')"
        class="p-error"
        style="display: block; margin-top: 0.25rem"
      >
        {{ getFieldError('amountTo') }}
      </small>
    </div>

    <!-- Note Field -->
    <div class="form-field">
      <label for="transaction-note" class="form-field__label">
        {{ "transactions.form.note" | translate }}
        <span class="note-optional">{{ "transactions.form.optional" | translate }}</span>
      </label>
      <div class="note-input-container">
        <textarea
          id="transaction-note"
          formControlName="note"
          [placeholder]="'transactions.form.notePlaceholder' | translate"
          [maxlength]="500"
          rows="3"
          [class.p-invalid]="
            transactionForm.get('note')?.invalid &&
            transactionForm.get('note')?.touched
          "
          class="note-input"
        ></textarea>
        <div class="note-character-count">
          {{ (transactionForm.get('note')?.value?.length || 0) }}/500
        </div>
      </div>
      <small
        *ngIf="getFieldError('note')"
        class="p-error"
        style="display: block; margin-top: 0.25rem"
      >
        {{ getFieldError('note') }}
      </small>
    </div>

    <!-- Effective Date Field -->
    <div class="form-field">
      <label for="transaction-date" class="form-field__label">
        {{ "transactions.form.effectiveDate" | translate }}
        <span class="required">{{ "transactions.form.required" | translate }}</span>
      </label>
      <div class="date-input-container">
        <p-calendar
          id="transaction-date"
          formControlName="effectiveDate"
          [placeholder]="'transactions.form.effectiveDatePlaceholder' | translate"
          [showIcon]="true"
          [showTime]="false"
          dateFormat="dd/mm/yy"
          [class.p-invalid]="
            transactionForm.get('effectiveDate')?.invalid &&
            transactionForm.get('effectiveDate')?.touched
          "
          styleClass="w-full date-picker-mobile"
        />
        <div class="date-quick-actions">
          <button 
            type="button" 
            class="date-quick-btn"
            (click)="setQuickDate('today')"
          >
            {{ "transactions.form.quickDate.today" | translate }}
          </button>
          <button 
            type="button" 
            class="date-quick-btn"
            (click)="setQuickDate('yesterday')"
          >
            {{ "transactions.form.quickDate.yesterday" | translate }}
          </button>
        </div>
      </div>
      <small
        *ngIf="getFieldError('effectiveDate')"
        class="p-error"
        style="display: block; margin-top: 0.25rem"
      >
        {{ getFieldError('effectiveDate') }}
      </small>
    </div>


    <!-- Form Actions -->
    <div class="transaction-form__actions">
      <pockito-button
        [type]="PockitoButtonType.CANCEL"
        [size]="PockitoButtonSize.MEDIUM"
        (click)="onCancel()"
        [disabled]="isLoading"
      >
        {{ "transactions.form.actions.cancel" | translate }}
      </pockito-button>

      <pockito-button
        [type]="PockitoButtonType.SUBMIT"
        [size]="PockitoButtonSize.MEDIUM"
        buttonType="submit"
        [loading]="isLoading"
        [disabled]="transactionForm.invalid || isLoading"
      >
        {{
          isEditMode
            ? ("transactions.form.actions.update" | translate)
            : ("transactions.form.actions.create" | translate)
        }}
      </pockito-button>
  </div>
  </form>
</div>
